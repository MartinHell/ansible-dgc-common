---
- name: create grafana database
  postgresql_db:
    name: "{{ grafana_db_dbname }}"
  when: hostvars[inventory_hostname]['repmgr_is_master'] is defined

- name: create grafana session database
  postgresql_db:
    name: "{{ grafana_session_dbname }}"
  register: session database
  when: hostvars[inventory_hostname]['repmgr_is_master'] is defined

- name: create grafana user
  postgresql_user:
    db: "{{ grafana_db_dbname }}"
    name: "{{ grafana_db_username }}"
    password: "{{ grafana_db_password }}"
  when: hostvars[inventory_hostname]['repmgr_is_master'] is defined

- name: create grafana session user
  postgresql_user:
    db: "{{ grafana_session_dbname }}"
    name: "{{ grafana_db_username }}"
    password: "{{ grafana_db_password }}"
  when: hostvars[inventory_hostname]['repmgr_is_master'] is defined

- name: create grafana session table
  command: psql -U grafana grafana_session -c 'CREATE TABLE IF NOT EXISTS session (key CHAR(16) NOT NULL, data BYTEA, expiry INTEGER NOT NULL, PRIMARY KEY (key) );'
  when:
    - session database
    - hostvars[inventory_hostname]['repmgr_is_master'] is defined
  become: true
